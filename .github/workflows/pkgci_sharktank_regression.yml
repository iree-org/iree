# Copyright 2025 The IREE Authors
#
# Licensed under the Apache License v2.0 with LLVM Exceptions.
# See https://llvm.org/LICENSE.txt for license information.
# SPDX-License-Identifier: Apache-2.0 WITH LLVM-exception

name: PkgCI Sharktank Regression Tests
on:
  workflow_call:
    inputs:
      artifact_run_id:
        type: string
        default: ""
  workflow_dispatch:
    inputs:
      artifact_run_id:
        type: string
        default: ""

jobs:
  sharktank_regression_tests:
    name: "sharktank_regression_tests :: ${{ matrix.name }}"
    runs-on: ${{ matrix.runs-on }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # CPU
          - name: cpu_task_model
            target: target_cpu
            gpu: none
            runs-on: ubuntu-24.04
          - name: cpu_llvm_task_regression
            models-config-file: models_cpu_llvm_task.json
            backend: cpu
            iree_test_files: /home/nod/iree_tests_cache
            runs-on:
              - self-hosted # must come first
              - persistent-cache
              - Linux
              - X64

          # AMD GPU
          - name: rocm_hip_w7900_model
            target: target_hip
            gpu: gfx1100
            runs-on: nodai-amdgpu-w7900-x86-64
          - name: rocm_hip_mi300_model
            target: target_hip
            gpu: gfx942
            runs-on: linux-mi300-2gpu-ossci-iree-org
          - name: amdgpu_rocm_mi250_gfx90a_regression
            rocm-chip: gfx90a
            backend: rocm
            iree_test_files: /home/esaimana/iree_tests_cache
            sku: mi250
            runs-on: nodai-amdgpu-mi250-x86-64
          - name: amdgpu_rocm_mi300_gfx942_regression
            rocm-chip: gfx942
            backend: rocm
            iree_test_files: /home/esaimana/iree_tests_cache
            sku: mi300
            runs-on: linux-mi300-1gpu-ossci-iree-org
          - name: amdgpu_rocm_mi308_gfx942_regression
            rocm-chip: gfx942
            backend: rocm
            iree_test_files: /home/esaimana/iree_tests_cache
            sku: mi308
            runs-on: nodai-amdgpu-mi308-x86-64

    env:
      VENV_DIR: ${{ github.workspace }}/venv
      GH_TOKEN: ${{ github.token }}
      PACKAGE_DOWNLOAD_DIR: ${{ github.workspace }}/.packages
      TEST_OUTPUT_ARTIFACTS: ${{ github.workspace }}/model_output_artifacts
      IREE_TEST_FILES: ${{ matrix.iree_test_files }}
    steps:
      - name: Checking out IREE repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
        with:
          submodules: false

      - uses: actions/setup-python@42375524e23c412d93fb67b49958b491fce71c38 # v5.4.0
        with:
          # Must match the subset of versions built in pkgci_build_packages.
          python-version: "3.11"

      - uses: actions/download-artifact@95815c38cf2ff2164869cbab79da8d1f422bc89e # v4.2.1
        if: ${{ inputs.artifact_run_id == '' }}
        with:
          name: linux_x86_64_release_packages
          path: ${{ env.PACKAGE_DOWNLOAD_DIR }}

      - name: "Set IREE_TEST_FILES variable"
        run: |
          case "${{ matrix.name }}" in
            "amdgpu_rocm_mi300_gfx942_regression") echo IREE_TEST_FILES="/shark-cache/data/iree-regression-cache" >> $GITHUB_ENV ;;
            *) echo "No cache directory assigned for ${{ matrix.name }}" ;;
          esac

      - name: Setup Python virtual environment
        run: |
          ./build_tools/pkgci/setup_venv.py ${VENV_DIR} \
            --artifact-path=${PACKAGE_DOWNLOAD_DIR} \
            --fetch-gh-workflow=${{ inputs.artifact_run_id }}

      - name: "Running Sharktank regression composite action"
        uses: geomin12/iree-test-suites/sharktank_models@cd55cfe471d862d3ab7df793195d601487c30dd8 # temporary until it works
        with:
          MATRIX_NAME: ${{ matrix.name }}
          SKU: ${{ matrix.sku }}
          CHIP: ${{ matrix.rocm-chip }}
          VENV_DIR: ${{ env.VENV_DIR }}
          TARGET: ${{ matrix.target }}
          GPU: ${{ matrix.gpu }}
          BACKEND: ${{ matrix.backend }}
          EXTERNAL_TEST_FILE_DIRECTORY: ${{ github.workspace }}/tests/external/iree-test-suites/test_suite_files
          QUALITY_TEST_DIRECTORY: ${{ github.workspace }}/tests/external/iree-test-suites/sharktank_models/quality_tests
          BENCHMARK_TEST_DIRECTORY: ${{ github.workspace }}/tests/external/iree-test-suites/sharktank_models/benchmarks
          IREE_TEST_FILES: ${{ env.IREE_TEST_FILES }}
