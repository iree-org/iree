################################################################################
# Autogenerated by build_tools/bazel_to_cmake/bazel_to_cmake.py from           #
# runtime/src/iree/builtins/ukernel/arch/x86_64/BUILD.bazel                    #
#                                                                              #
# Use iree_cmake_extra_content from iree/build_defs.oss.bzl to add arbitrary   #
# CMake-only content.                                                          #
#                                                                              #
# To disable autogeneration for this file entirely, delete this header.        #
################################################################################

iree_add_all_subdirs()

if(IREE_BUILD_COMPILER AND IREE_TARGET_BACKEND_LLVM_CPU)

iree_bitcode_library(
  NAME
    ukernel_bitcode_x86_64_base
  SRCS
    "mmt4d_x86_64.c"
    "pack_x86_64.c"
    "query_tile_sizes_x86_64.c"
    "unpack_x86_64.c"
  HDRS
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:common_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:mmt4d_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:pack_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:query_tile_sizes_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:unpack_x86_64.h"
    "//runtime/src/iree/builtins/ukernel:api.h"
    "//runtime/src/iree/builtins/ukernel:common.h"
    "//runtime/src/iree/builtins/ukernel:elementwise.h"
    "//runtime/src/iree/builtins/ukernel:exported_bits.h"
    "//runtime/src/iree/builtins/ukernel:mmt4d.h"
    "//runtime/src/iree/builtins/ukernel:mmt4d_internal.h"
    "//runtime/src/iree/builtins/ukernel:pack.h"
    "//runtime/src/iree/builtins/ukernel:pack_internal.h"
    "//runtime/src/iree/builtins/ukernel:query_tile_sizes.h"
    "//runtime/src/iree/builtins/ukernel:query_tile_sizes_internal.h"
    "//runtime/src/iree/builtins/ukernel:static_assert.h"
    "//runtime/src/iree/builtins/ukernel:unpack.h"
    "//runtime/src/iree/builtins/ukernel:unpack_internal.h"
    "//runtime/src/iree/schemas:cpu_data.h"
    "//runtime/src/iree/schemas:cpu_feature_bits.inl"
  COPTS
    "-std=c17"
    "-nostdinc"
    "-ffreestanding"
    "-O3"
    "-DNDEBUG"
    "-fno-ident"
    "-fdiscard-value-names"
    "-fno-short-wchar"
    "-c"
    "-emit-llvm"
    "-DIREE_UK_STANDALONE=1"
    "-march=x86-64"
    "-DIREE_UK_ARCH_X86_64"
    "-DIREE_UK_POINTER_SIZE=8"
    "-DIREE_UK_BUILD_X86_64_AVX2_FMA"
    "-DIREE_UK_BUILD_X86_64_AVX512_BASE"
    "-DIREE_UK_BUILD_X86_64_AVX512_VNNI"
  PUBLIC
)

iree_bitcode_library(
  NAME
    ukernel_bitcode_x86_64_avx2_fma
  SRCS
    "mmt4d_x86_64_avx2_fma.c"
    "pack_x86_64_avx2_fma.c"
    "unpack_x86_64_avx2_fma.c"
  HDRS
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:common_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:mmt4d_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:pack_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:query_tile_sizes_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:unpack_x86_64.h"
    "//runtime/src/iree/builtins/ukernel:api.h"
    "//runtime/src/iree/builtins/ukernel:common.h"
    "//runtime/src/iree/builtins/ukernel:elementwise.h"
    "//runtime/src/iree/builtins/ukernel:exported_bits.h"
    "//runtime/src/iree/builtins/ukernel:mmt4d.h"
    "//runtime/src/iree/builtins/ukernel:mmt4d_internal.h"
    "//runtime/src/iree/builtins/ukernel:pack.h"
    "//runtime/src/iree/builtins/ukernel:pack_internal.h"
    "//runtime/src/iree/builtins/ukernel:query_tile_sizes.h"
    "//runtime/src/iree/builtins/ukernel:query_tile_sizes_internal.h"
    "//runtime/src/iree/builtins/ukernel:static_assert.h"
    "//runtime/src/iree/builtins/ukernel:unpack.h"
    "//runtime/src/iree/builtins/ukernel:unpack_internal.h"
    "//runtime/src/iree/schemas:cpu_data.h"
    "//runtime/src/iree/schemas:cpu_feature_bits.inl"
  COPTS
    "-std=c17"
    "-nostdinc"
    "-ffreestanding"
    "-O3"
    "-DNDEBUG"
    "-fno-ident"
    "-fdiscard-value-names"
    "-fno-short-wchar"
    "-c"
    "-emit-llvm"
    "-DIREE_UK_STANDALONE=1"
    "-march=x86-64"
    "-DIREE_UK_ARCH_X86_64"
    "-DIREE_UK_POINTER_SIZE=8"
    "-DIREE_UK_BUILD_X86_64_AVX2_FMA"
    "-DIREE_UK_BUILD_X86_64_AVX512_BASE"
    "-DIREE_UK_BUILD_X86_64_AVX512_VNNI"
    "-mavx2"
    "-mfma"
  PUBLIC
)

iree_bitcode_library(
  NAME
    ukernel_bitcode_x86_64_avx512_base
  SRCS
    "mmt4d_x86_64_avx512_base.c"
    "pack_x86_64_avx512_base.c"
    "unpack_x86_64_avx512_base.c"
  HDRS
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:common_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:mmt4d_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:pack_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:query_tile_sizes_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:unpack_x86_64.h"
    "//runtime/src/iree/builtins/ukernel:api.h"
    "//runtime/src/iree/builtins/ukernel:common.h"
    "//runtime/src/iree/builtins/ukernel:elementwise.h"
    "//runtime/src/iree/builtins/ukernel:exported_bits.h"
    "//runtime/src/iree/builtins/ukernel:mmt4d.h"
    "//runtime/src/iree/builtins/ukernel:mmt4d_internal.h"
    "//runtime/src/iree/builtins/ukernel:pack.h"
    "//runtime/src/iree/builtins/ukernel:pack_internal.h"
    "//runtime/src/iree/builtins/ukernel:query_tile_sizes.h"
    "//runtime/src/iree/builtins/ukernel:query_tile_sizes_internal.h"
    "//runtime/src/iree/builtins/ukernel:static_assert.h"
    "//runtime/src/iree/builtins/ukernel:unpack.h"
    "//runtime/src/iree/builtins/ukernel:unpack_internal.h"
    "//runtime/src/iree/schemas:cpu_data.h"
    "//runtime/src/iree/schemas:cpu_feature_bits.inl"
  COPTS
    "-std=c17"
    "-nostdinc"
    "-ffreestanding"
    "-O3"
    "-DNDEBUG"
    "-fno-ident"
    "-fdiscard-value-names"
    "-fno-short-wchar"
    "-c"
    "-emit-llvm"
    "-DIREE_UK_STANDALONE=1"
    "-march=x86-64"
    "-DIREE_UK_ARCH_X86_64"
    "-DIREE_UK_POINTER_SIZE=8"
    "-DIREE_UK_BUILD_X86_64_AVX2_FMA"
    "-DIREE_UK_BUILD_X86_64_AVX512_BASE"
    "-DIREE_UK_BUILD_X86_64_AVX512_VNNI"
    "-mavx512f"
    "-mavx512vl"
    "-mavx512cd"
    "-mavx512bw"
    "-mavx512dq"
  PUBLIC
)

iree_bitcode_library(
  NAME
    ukernel_bitcode_x86_64_avx512_vnni
  SRCS
    "mmt4d_x86_64_avx512_vnni.c"
  HDRS
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:common_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:mmt4d_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:pack_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:query_tile_sizes_x86_64.h"
    "//runtime/src/iree/builtins/ukernel/arch/x86_64:unpack_x86_64.h"
    "//runtime/src/iree/builtins/ukernel:api.h"
    "//runtime/src/iree/builtins/ukernel:common.h"
    "//runtime/src/iree/builtins/ukernel:elementwise.h"
    "//runtime/src/iree/builtins/ukernel:exported_bits.h"
    "//runtime/src/iree/builtins/ukernel:mmt4d.h"
    "//runtime/src/iree/builtins/ukernel:mmt4d_internal.h"
    "//runtime/src/iree/builtins/ukernel:pack.h"
    "//runtime/src/iree/builtins/ukernel:pack_internal.h"
    "//runtime/src/iree/builtins/ukernel:query_tile_sizes.h"
    "//runtime/src/iree/builtins/ukernel:query_tile_sizes_internal.h"
    "//runtime/src/iree/builtins/ukernel:static_assert.h"
    "//runtime/src/iree/builtins/ukernel:unpack.h"
    "//runtime/src/iree/builtins/ukernel:unpack_internal.h"
    "//runtime/src/iree/schemas:cpu_data.h"
    "//runtime/src/iree/schemas:cpu_feature_bits.inl"
  COPTS
    "-std=c17"
    "-nostdinc"
    "-ffreestanding"
    "-O3"
    "-DNDEBUG"
    "-fno-ident"
    "-fdiscard-value-names"
    "-fno-short-wchar"
    "-c"
    "-emit-llvm"
    "-DIREE_UK_STANDALONE=1"
    "-march=x86-64"
    "-DIREE_UK_ARCH_X86_64"
    "-DIREE_UK_POINTER_SIZE=8"
    "-DIREE_UK_BUILD_X86_64_AVX2_FMA"
    "-DIREE_UK_BUILD_X86_64_AVX512_BASE"
    "-DIREE_UK_BUILD_X86_64_AVX512_VNNI"
    "-mavx512f"
    "-mavx512vl"
    "-mavx512cd"
    "-mavx512bw"
    "-mavx512dq"
    "-mavx512vnni"
  PUBLIC
)

endif()  # IREE_BUILD_COMPILER AND IREE_TARGET_BACKEND_LLVM_CPU

### BAZEL_TO_CMAKE_PRESERVES_ALL_CONTENT_BELOW_THIS_LINE ###

if (NOT (IREE_ARCH STREQUAL "x86_64"))
  return()
endif()

# Target CPUs supporting AVX2+FMA3. That includes Intel Haswell (2013) and newer
# and AMD Excavator (2015) and newer. There is no current plan to look after
# SIMD performance on x86 microarchitectures not supporting this.
iree_select_compiler_opts(IREE_UK_COPTS_X86_64_AVX2_FMA
  CLANG_OR_GCC
    "-mavx2"
    "-mfma"
  MSVC
    "/arch:AVX2"
)

# TODO: Support AVX-VNNI and/or AVX-VNNI-INT8?
# 1. AVX-VNNI is the 256-bit backport of AVX-512-VNNI. It is supported in Alder
#    Lake (2022).
# 2  AVX-VNNI-INT8 is a future ISA extension not yet mentioned in the Intel SDM,
#    but we can glean the following information from these links: it will be
#    supported in Sierra Forest (2024) it will introduce VPDPBSSD, the missing
#    signed*signed counterpart to VNNI's VPDPBUSD, meaning we will finally be
#    able to use the 8bit path, so that VNNI-IN8 will be a >= 2x win for us over
#    VNNI.
#    https://en.wikipedia.org/wiki/Sierra_Forest
#    https://gcc.gnu.org/pipermail/gcc-patches/2022-October/603546.html
#    https://gcc.gnu.org/git/?p=gcc.git;a=commitdiff;h=406675947d26ccbc2108e9689a2918bb36f61a63


# Target CPUs supporting the typical baseline AVX-512 features (F+VL+CD+BW+DQ).
# That includes Intel Skylake/server (2017) and AMD Zen4 (2022) while recent
# non-server x86 microarchitectures not supporting this continue to exist.
iree_select_compiler_opts(IREE_UK_COPTS_X86_64_AVX512_BASE
  CLANG_OR_GCC
    "-mavx512f"
    "-mavx512vl"
    "-mavx512cd"
    "-mavx512bw"
    "-mavx512dq"
  MSVC
    "/arch:AVX512"
)

# Target CPUs supporting the AVX-512 VNNI feature. That includes Intel Sunny
# Cove (2019) and newer, and AMD Zen4 (2022).
iree_select_compiler_opts(IREE_UK_COPTS_X86_64_AVX512_VNNI_RELATIVE
  CLANG_OR_GCC
    "-mavx512vnni"
  MSVC
)
set(IREE_UK_COPTS_X86_64_AVX512_VNNI
  "${IREE_UK_COPTS_X86_64_AVX512_BASE}"
  "${IREE_UK_COPTS_X86_64_AVX512_VNNI_RELATIVE}"
)

check_cxx_compiler_flag("${IREE_UK_COPTS_X86_64_AVX2_FMA}" IREE_UK_BUILD_X86_64_AVX2_FMA)
check_cxx_compiler_flag("${IREE_UK_COPTS_X86_64_AVX512_BASE}" IREE_UK_BUILD_X86_64_AVX512_BASE)
check_cxx_compiler_flag("${IREE_UK_COPTS_X86_64_AVX512_VNNI}" IREE_UK_BUILD_X86_64_AVX512_VNNI)

configure_file(config.h.in config.h)

iree_cc_library(
  NAME
    config
  HDRS
    ${CMAKE_CURRENT_BINARY_DIR}/config.h
)

iree_cc_library(
  NAME
    common_x86_64
  HDRS
    "common_x86_64.h"
  DEPS
    iree::builtins::ukernel::internal_headers
    iree::schemas::cpu_data
)

if(IREE_UK_BUILD_X86_64_AVX2_FMA)
  iree_cc_library(
    NAME
      x86_64_avx2_fma
    SRCS
      "mmt4d_x86_64_avx2_fma.c"
      "pack_x86_64_avx2_fma.c"
      "unpack_x86_64_avx2_fma.c"
    COPTS
      "${IREE_UK_COPTS_X86_64_AVX2_FMA}"
    DEPS
      iree::builtins::ukernel::internal_headers
  )
  list(APPEND IREE_UK_X86_64_DEPS "iree::builtins::ukernel::arch::x86_64::x86_64_avx2_fma")
endif()

if(IREE_UK_BUILD_X86_64_AVX512_BASE)
  iree_cc_library(
    NAME
      x86_64_avx512_base
    SRCS
      "mmt4d_x86_64_avx512_base.c"
      "pack_x86_64_avx512_base.c"
      "unpack_x86_64_avx512_base.c"
    COPTS
      "${IREE_UK_COPTS_X86_64_AVX512_BASE}"
    DEPS
      iree::builtins::ukernel::internal_headers
  )
  list(APPEND IREE_UK_X86_64_DEPS "iree::builtins::ukernel::arch::x86_64::x86_64_avx512_base")
endif()

if(IREE_UK_BUILD_X86_64_AVX512_VNNI)
  iree_cc_library(
    NAME
      x86_64_avx512_vnni
    SRCS
      "mmt4d_x86_64_avx512_vnni.c"
    COPTS
      "${IREE_UK_COPTS_X86_64_AVX512_VNNI}"
    DEPS
      iree::builtins::ukernel::internal_headers
  )
  list(APPEND IREE_UK_X86_64_DEPS "iree::builtins::ukernel::arch::x86_64::x86_64_avx512_vnni")
endif()


iree_cc_library(
  NAME
    x86_64
  HDRS
    "mmt4d_x86_64.h"
    "pack_x86_64.h"
    "query_tile_sizes_x86_64.h"
    "unpack_x86_64.h"
  SRCS
    "mmt4d_x86_64.c"
    "pack_x86_64.c"
    "query_tile_sizes_x86_64.c"
    "unpack_x86_64.c"
  DEPS
    ::common_x86_64
    iree::base::core_headers
    iree::builtins::ukernel::internal_headers
    ${IREE_UK_X86_64_DEPS}
  PUBLIC
)
